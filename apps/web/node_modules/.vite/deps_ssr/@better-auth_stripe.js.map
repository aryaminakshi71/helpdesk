{
  "version": 3,
  "sources": ["../../../../../node_modules/.bun/@better-auth+stripe@1.4.14+5fd151e66d5fa53d/node_modules/@better-auth/stripe/dist/index.mjs"],
  "sourcesContent": ["import { APIError, HIDE_METADATA } from \"better-auth\";\nimport { defu } from \"defu\";\nimport { defineErrorCodes } from \"@better-auth/core/utils\";\nimport { createAuthEndpoint, createAuthMiddleware } from \"@better-auth/core/api\";\nimport { APIError as APIError$1, getSessionFromCtx, originCheck, sessionMiddleware } from \"better-auth/api\";\nimport * as z from \"zod/v4\";\nimport { mergeSchema } from \"better-auth/db\";\n\n//#region src/error-codes.ts\nconst STRIPE_ERROR_CODES = defineErrorCodes({\n\tUNAUTHORIZED: \"Unauthorized access\",\n\tINVALID_REQUEST_BODY: \"Invalid request body\",\n\tSUBSCRIPTION_NOT_FOUND: \"Subscription not found\",\n\tSUBSCRIPTION_PLAN_NOT_FOUND: \"Subscription plan not found\",\n\tALREADY_SUBSCRIBED_PLAN: \"You're already subscribed to this plan\",\n\tREFERENCE_ID_NOT_ALLOWED: \"Reference id is not allowed\",\n\tCUSTOMER_NOT_FOUND: \"Stripe customer not found for this user\",\n\tUNABLE_TO_CREATE_CUSTOMER: \"Unable to create customer\",\n\tUNABLE_TO_CREATE_BILLING_PORTAL: \"Unable to create billing portal session\",\n\tSTRIPE_SIGNATURE_NOT_FOUND: \"Stripe signature not found\",\n\tSTRIPE_WEBHOOK_SECRET_NOT_FOUND: \"Stripe webhook secret not found\",\n\tSTRIPE_WEBHOOK_ERROR: \"Stripe webhook error\",\n\tFAILED_TO_CONSTRUCT_STRIPE_EVENT: \"Failed to construct Stripe event\",\n\tFAILED_TO_FETCH_PLANS: \"Failed to fetch plans\",\n\tEMAIL_VERIFICATION_REQUIRED: \"Email verification is required before you can subscribe to a plan\",\n\tSUBSCRIPTION_NOT_ACTIVE: \"Subscription is not active\",\n\tSUBSCRIPTION_NOT_SCHEDULED_FOR_CANCELLATION: \"Subscription is not scheduled for cancellation\",\n\tORGANIZATION_NOT_FOUND: \"Organization not found\",\n\tORGANIZATION_SUBSCRIPTION_NOT_ENABLED: \"Organization subscription is not enabled\",\n\tORGANIZATION_HAS_ACTIVE_SUBSCRIPTION: \"Cannot delete organization with active subscription\",\n\tORGANIZATION_REFERENCE_ID_REQUIRED: \"Reference ID is required. Provide referenceId or set activeOrganizationId in session\"\n});\n\n//#endregion\n//#region src/utils.ts\nasync function getPlans(subscriptionOptions) {\n\tif (subscriptionOptions?.enabled) return typeof subscriptionOptions.plans === \"function\" ? await subscriptionOptions.plans() : subscriptionOptions.plans;\n\tthrow new Error(\"Subscriptions are not enabled in the Stripe options.\");\n}\nasync function getPlanByPriceInfo(options, priceId, priceLookupKey) {\n\treturn await getPlans(options.subscription).then((res) => res?.find((plan) => plan.priceId === priceId || plan.annualDiscountPriceId === priceId || priceLookupKey && (plan.lookupKey === priceLookupKey || plan.annualDiscountLookupKey === priceLookupKey)));\n}\nasync function getPlanByName(options, name) {\n\treturn await getPlans(options.subscription).then((res) => res?.find((plan) => plan.name.toLowerCase() === name.toLowerCase()));\n}\n/**\n* Checks if a subscription is in an available state (active or trialing)\n*/\nfunction isActiveOrTrialing(sub) {\n\treturn sub.status === \"active\" || sub.status === \"trialing\";\n}\n/**\n* Check if a subscription is scheduled to be canceled (DB subscription object)\n*/\nfunction isPendingCancel(sub) {\n\treturn !!(sub.cancelAtPeriodEnd || sub.cancelAt);\n}\n/**\n* Check if a Stripe subscription is scheduled to be canceled (Stripe API response)\n*/\nfunction isStripePendingCancel(stripeSub) {\n\treturn !!(stripeSub.cancel_at_period_end || stripeSub.cancel_at);\n}\n/**\n* Escapes a value for use in Stripe search queries.\n* Stripe search query uses double quotes for string values,\n* and double quotes within the value need to be escaped with backslash.\n*\n* @see https://docs.stripe.com/search#search-query-language\n*/\nfunction escapeStripeSearchValue(value) {\n\treturn value.replace(/\"/g, \"\\\\\\\"\");\n}\n\n//#endregion\n//#region src/hooks.ts\n/**\n* Find organization or user by stripeCustomerId.\n* @internal\n*/\nasync function findReferenceByStripeCustomerId(ctx, options, stripeCustomerId) {\n\tif (options.organization?.enabled) {\n\t\tconst org = await ctx.context.adapter.findOne({\n\t\t\tmodel: \"organization\",\n\t\t\twhere: [{\n\t\t\t\tfield: \"stripeCustomerId\",\n\t\t\t\tvalue: stripeCustomerId\n\t\t\t}]\n\t\t});\n\t\tif (org) return {\n\t\t\tcustomerType: \"organization\",\n\t\t\treferenceId: org.id\n\t\t};\n\t}\n\tconst user$1 = await ctx.context.adapter.findOne({\n\t\tmodel: \"user\",\n\t\twhere: [{\n\t\t\tfield: \"stripeCustomerId\",\n\t\t\tvalue: stripeCustomerId\n\t\t}]\n\t});\n\tif (user$1) return {\n\t\tcustomerType: \"user\",\n\t\treferenceId: user$1.id\n\t};\n\treturn null;\n}\nasync function onCheckoutSessionCompleted(ctx, options, event) {\n\ttry {\n\t\tconst client = options.stripeClient;\n\t\tconst checkoutSession = event.data.object;\n\t\tif (checkoutSession.mode === \"setup\" || !options.subscription?.enabled) return;\n\t\tconst subscription = await client.subscriptions.retrieve(checkoutSession.subscription);\n\t\tconst subscriptionItem = subscription.items.data[0];\n\t\tif (!subscriptionItem) {\n\t\t\tctx.context.logger.warn(`Stripe webhook warning: Subscription ${subscription.id} has no items`);\n\t\t\treturn;\n\t\t}\n\t\tconst priceId = subscriptionItem.price.id;\n\t\tconst priceLookupKey = subscriptionItem.price.lookup_key;\n\t\tconst plan = await getPlanByPriceInfo(options, priceId, priceLookupKey);\n\t\tif (plan) {\n\t\t\tconst referenceId = checkoutSession?.client_reference_id || checkoutSession?.metadata?.referenceId;\n\t\t\tconst subscriptionId = checkoutSession?.metadata?.subscriptionId;\n\t\t\tconst seats = subscriptionItem.quantity;\n\t\t\tif (referenceId && subscriptionId) {\n\t\t\t\tconst trial = subscription.trial_start && subscription.trial_end ? {\n\t\t\t\t\ttrialStart: /* @__PURE__ */ new Date(subscription.trial_start * 1e3),\n\t\t\t\t\ttrialEnd: /* @__PURE__ */ new Date(subscription.trial_end * 1e3)\n\t\t\t\t} : {};\n\t\t\t\tlet dbSubscription = await ctx.context.adapter.update({\n\t\t\t\t\tmodel: \"subscription\",\n\t\t\t\t\tupdate: {\n\t\t\t\t\t\tplan: plan.name.toLowerCase(),\n\t\t\t\t\t\tstatus: subscription.status,\n\t\t\t\t\t\tupdatedAt: /* @__PURE__ */ new Date(),\n\t\t\t\t\t\tperiodStart: /* @__PURE__ */ new Date(subscriptionItem.current_period_start * 1e3),\n\t\t\t\t\t\tperiodEnd: /* @__PURE__ */ new Date(subscriptionItem.current_period_end * 1e3),\n\t\t\t\t\t\tstripeSubscriptionId: checkoutSession.subscription,\n\t\t\t\t\t\tcancelAtPeriodEnd: subscription.cancel_at_period_end,\n\t\t\t\t\t\tcancelAt: subscription.cancel_at ? /* @__PURE__ */ new Date(subscription.cancel_at * 1e3) : null,\n\t\t\t\t\t\tcanceledAt: subscription.canceled_at ? /* @__PURE__ */ new Date(subscription.canceled_at * 1e3) : null,\n\t\t\t\t\t\tendedAt: subscription.ended_at ? /* @__PURE__ */ new Date(subscription.ended_at * 1e3) : null,\n\t\t\t\t\t\tseats,\n\t\t\t\t\t\t...trial\n\t\t\t\t\t},\n\t\t\t\t\twhere: [{\n\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\tvalue: subscriptionId\n\t\t\t\t\t}]\n\t\t\t\t});\n\t\t\t\tif (trial.trialStart && plan.freeTrial?.onTrialStart) await plan.freeTrial.onTrialStart(dbSubscription);\n\t\t\t\tif (!dbSubscription) dbSubscription = await ctx.context.adapter.findOne({\n\t\t\t\t\tmodel: \"subscription\",\n\t\t\t\t\twhere: [{\n\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\tvalue: subscriptionId\n\t\t\t\t\t}]\n\t\t\t\t});\n\t\t\t\tawait options.subscription?.onSubscriptionComplete?.({\n\t\t\t\t\tevent,\n\t\t\t\t\tsubscription: dbSubscription,\n\t\t\t\t\tstripeSubscription: subscription,\n\t\t\t\t\tplan\n\t\t\t\t}, ctx);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t} catch (e) {\n\t\tctx.context.logger.error(`Stripe webhook failed. Error: ${e.message}`);\n\t}\n}\nasync function onSubscriptionCreated(ctx, options, event) {\n\ttry {\n\t\tif (!options.subscription?.enabled) return;\n\t\tconst subscriptionCreated = event.data.object;\n\t\tconst stripeCustomerId = subscriptionCreated.customer?.toString();\n\t\tif (!stripeCustomerId) {\n\t\t\tctx.context.logger.warn(`Stripe webhook warning: customer.subscription.created event received without customer ID`);\n\t\t\treturn;\n\t\t}\n\t\tconst subscriptionId = subscriptionCreated.metadata?.subscriptionId;\n\t\tconst existingSubscription = await ctx.context.adapter.findOne({\n\t\t\tmodel: \"subscription\",\n\t\t\twhere: subscriptionId ? [{\n\t\t\t\tfield: \"id\",\n\t\t\t\tvalue: subscriptionId\n\t\t\t}] : [{\n\t\t\t\tfield: \"stripeSubscriptionId\",\n\t\t\t\tvalue: subscriptionCreated.id\n\t\t\t}]\n\t\t});\n\t\tif (existingSubscription) {\n\t\t\tctx.context.logger.info(`Stripe webhook: Subscription already exists in database (id: ${existingSubscription.id}), skipping creation`);\n\t\t\treturn;\n\t\t}\n\t\tconst reference = await findReferenceByStripeCustomerId(ctx, options, stripeCustomerId);\n\t\tif (!reference) {\n\t\t\tctx.context.logger.warn(`Stripe webhook warning: No user or organization found with stripeCustomerId: ${stripeCustomerId}`);\n\t\t\treturn;\n\t\t}\n\t\tconst { referenceId, customerType } = reference;\n\t\tconst subscriptionItem = subscriptionCreated.items.data[0];\n\t\tif (!subscriptionItem) {\n\t\t\tctx.context.logger.warn(`Stripe webhook warning: Subscription ${subscriptionCreated.id} has no items`);\n\t\t\treturn;\n\t\t}\n\t\tconst priceId = subscriptionItem.price.id;\n\t\tconst plan = await getPlanByPriceInfo(options, priceId, subscriptionItem.price.lookup_key || null);\n\t\tif (!plan) {\n\t\t\tctx.context.logger.warn(`Stripe webhook warning: No matching plan found for priceId: ${priceId}`);\n\t\t\treturn;\n\t\t}\n\t\tconst seats = subscriptionItem.quantity;\n\t\tconst periodStart = /* @__PURE__ */ new Date(subscriptionItem.current_period_start * 1e3);\n\t\tconst periodEnd = /* @__PURE__ */ new Date(subscriptionItem.current_period_end * 1e3);\n\t\tconst trial = subscriptionCreated.trial_start && subscriptionCreated.trial_end ? {\n\t\t\ttrialStart: /* @__PURE__ */ new Date(subscriptionCreated.trial_start * 1e3),\n\t\t\ttrialEnd: /* @__PURE__ */ new Date(subscriptionCreated.trial_end * 1e3)\n\t\t} : {};\n\t\tconst newSubscription = await ctx.context.adapter.create({\n\t\t\tmodel: \"subscription\",\n\t\t\tdata: {\n\t\t\t\treferenceId,\n\t\t\t\tstripeCustomerId,\n\t\t\t\tstripeSubscriptionId: subscriptionCreated.id,\n\t\t\t\tstatus: subscriptionCreated.status,\n\t\t\t\tplan: plan.name.toLowerCase(),\n\t\t\t\tperiodStart,\n\t\t\t\tperiodEnd,\n\t\t\t\tseats,\n\t\t\t\t...plan.limits ? { limits: plan.limits } : {},\n\t\t\t\t...trial\n\t\t\t}\n\t\t});\n\t\tctx.context.logger.info(`Stripe webhook: Created subscription ${subscriptionCreated.id} for ${customerType} ${referenceId} from dashboard`);\n\t\tawait options.subscription.onSubscriptionCreated?.({\n\t\t\tevent,\n\t\t\tsubscription: newSubscription,\n\t\t\tstripeSubscription: subscriptionCreated,\n\t\t\tplan\n\t\t});\n\t} catch (error) {\n\t\tctx.context.logger.error(`Stripe webhook failed. Error: ${error}`);\n\t}\n}\nasync function onSubscriptionUpdated(ctx, options, event) {\n\ttry {\n\t\tif (!options.subscription?.enabled) return;\n\t\tconst subscriptionUpdated = event.data.object;\n\t\tconst subscriptionItem = subscriptionUpdated.items.data[0];\n\t\tif (!subscriptionItem) {\n\t\t\tctx.context.logger.warn(`Stripe webhook warning: Subscription ${subscriptionUpdated.id} has no items`);\n\t\t\treturn;\n\t\t}\n\t\tconst priceId = subscriptionItem.price.id;\n\t\tconst priceLookupKey = subscriptionItem.price.lookup_key;\n\t\tconst plan = await getPlanByPriceInfo(options, priceId, priceLookupKey);\n\t\tconst subscriptionId = subscriptionUpdated.metadata?.subscriptionId;\n\t\tconst customerId = subscriptionUpdated.customer?.toString();\n\t\tlet subscription = await ctx.context.adapter.findOne({\n\t\t\tmodel: \"subscription\",\n\t\t\twhere: subscriptionId ? [{\n\t\t\t\tfield: \"id\",\n\t\t\t\tvalue: subscriptionId\n\t\t\t}] : [{\n\t\t\t\tfield: \"stripeSubscriptionId\",\n\t\t\t\tvalue: subscriptionUpdated.id\n\t\t\t}]\n\t\t});\n\t\tif (!subscription) {\n\t\t\tconst subs = await ctx.context.adapter.findMany({\n\t\t\t\tmodel: \"subscription\",\n\t\t\t\twhere: [{\n\t\t\t\t\tfield: \"stripeCustomerId\",\n\t\t\t\t\tvalue: customerId\n\t\t\t\t}]\n\t\t\t});\n\t\t\tif (subs.length > 1) {\n\t\t\t\tconst activeSub = subs.find((sub) => isActiveOrTrialing(sub));\n\t\t\t\tif (!activeSub) {\n\t\t\t\t\tctx.context.logger.warn(`Stripe webhook error: Multiple subscriptions found for customerId: ${customerId} and no active subscription is found`);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tsubscription = activeSub;\n\t\t\t} else subscription = subs[0];\n\t\t}\n\t\tconst updatedSubscription = await ctx.context.adapter.update({\n\t\t\tmodel: \"subscription\",\n\t\t\tupdate: {\n\t\t\t\t...plan ? {\n\t\t\t\t\tplan: plan.name.toLowerCase(),\n\t\t\t\t\tlimits: plan.limits\n\t\t\t\t} : {},\n\t\t\t\tupdatedAt: /* @__PURE__ */ new Date(),\n\t\t\t\tstatus: subscriptionUpdated.status,\n\t\t\t\tperiodStart: /* @__PURE__ */ new Date(subscriptionItem.current_period_start * 1e3),\n\t\t\t\tperiodEnd: /* @__PURE__ */ new Date(subscriptionItem.current_period_end * 1e3),\n\t\t\t\tcancelAtPeriodEnd: subscriptionUpdated.cancel_at_period_end,\n\t\t\t\tcancelAt: subscriptionUpdated.cancel_at ? /* @__PURE__ */ new Date(subscriptionUpdated.cancel_at * 1e3) : null,\n\t\t\t\tcanceledAt: subscriptionUpdated.canceled_at ? /* @__PURE__ */ new Date(subscriptionUpdated.canceled_at * 1e3) : null,\n\t\t\t\tendedAt: subscriptionUpdated.ended_at ? /* @__PURE__ */ new Date(subscriptionUpdated.ended_at * 1e3) : null,\n\t\t\t\tseats: subscriptionItem.quantity,\n\t\t\t\tstripeSubscriptionId: subscriptionUpdated.id\n\t\t\t},\n\t\t\twhere: [{\n\t\t\t\tfield: \"id\",\n\t\t\t\tvalue: subscription.id\n\t\t\t}]\n\t\t});\n\t\tif (subscriptionUpdated.status === \"active\" && isStripePendingCancel(subscriptionUpdated) && !isPendingCancel(subscription)) await options.subscription.onSubscriptionCancel?.({\n\t\t\tsubscription,\n\t\t\tcancellationDetails: subscriptionUpdated.cancellation_details || void 0,\n\t\t\tstripeSubscription: subscriptionUpdated,\n\t\t\tevent\n\t\t});\n\t\tawait options.subscription.onSubscriptionUpdate?.({\n\t\t\tevent,\n\t\t\tsubscription: updatedSubscription || subscription\n\t\t});\n\t\tif (plan) {\n\t\t\tif (subscriptionUpdated.status === \"active\" && subscription.status === \"trialing\" && plan.freeTrial?.onTrialEnd) await plan.freeTrial.onTrialEnd({ subscription }, ctx);\n\t\t\tif (subscriptionUpdated.status === \"incomplete_expired\" && subscription.status === \"trialing\" && plan.freeTrial?.onTrialExpired) await plan.freeTrial.onTrialExpired(subscription, ctx);\n\t\t}\n\t} catch (error) {\n\t\tctx.context.logger.error(`Stripe webhook failed. Error: ${error}`);\n\t}\n}\nasync function onSubscriptionDeleted(ctx, options, event) {\n\tif (!options.subscription?.enabled) return;\n\ttry {\n\t\tconst subscriptionDeleted = event.data.object;\n\t\tconst subscriptionId = subscriptionDeleted.id;\n\t\tconst subscription = await ctx.context.adapter.findOne({\n\t\t\tmodel: \"subscription\",\n\t\t\twhere: [{\n\t\t\t\tfield: \"stripeSubscriptionId\",\n\t\t\t\tvalue: subscriptionId\n\t\t\t}]\n\t\t});\n\t\tif (subscription) {\n\t\t\tawait ctx.context.adapter.update({\n\t\t\t\tmodel: \"subscription\",\n\t\t\t\twhere: [{\n\t\t\t\t\tfield: \"id\",\n\t\t\t\t\tvalue: subscription.id\n\t\t\t\t}],\n\t\t\t\tupdate: {\n\t\t\t\t\tstatus: \"canceled\",\n\t\t\t\t\tupdatedAt: /* @__PURE__ */ new Date(),\n\t\t\t\t\tcancelAtPeriodEnd: subscriptionDeleted.cancel_at_period_end,\n\t\t\t\t\tcancelAt: subscriptionDeleted.cancel_at ? /* @__PURE__ */ new Date(subscriptionDeleted.cancel_at * 1e3) : null,\n\t\t\t\t\tcanceledAt: subscriptionDeleted.canceled_at ? /* @__PURE__ */ new Date(subscriptionDeleted.canceled_at * 1e3) : null,\n\t\t\t\t\tendedAt: subscriptionDeleted.ended_at ? /* @__PURE__ */ new Date(subscriptionDeleted.ended_at * 1e3) : null\n\t\t\t\t}\n\t\t\t});\n\t\t\tawait options.subscription.onSubscriptionDeleted?.({\n\t\t\t\tevent,\n\t\t\t\tstripeSubscription: subscriptionDeleted,\n\t\t\t\tsubscription\n\t\t\t});\n\t\t} else ctx.context.logger.warn(`Stripe webhook error: Subscription not found for subscriptionId: ${subscriptionId}`);\n\t} catch (error) {\n\t\tctx.context.logger.error(`Stripe webhook failed. Error: ${error}`);\n\t}\n}\n\n//#endregion\n//#region src/middleware.ts\nconst stripeSessionMiddleware = createAuthMiddleware({ use: [sessionMiddleware] }, async (ctx) => {\n\treturn { session: ctx.context.session };\n});\nconst referenceMiddleware = (subscriptionOptions, action) => createAuthMiddleware(async (ctx) => {\n\tconst ctxSession = ctx.context.session;\n\tif (!ctxSession) throw new APIError$1(\"UNAUTHORIZED\", { message: STRIPE_ERROR_CODES.UNAUTHORIZED });\n\tconst customerType = ctx.body?.customerType || ctx.query?.customerType;\n\tconst explicitReferenceId = ctx.body?.referenceId || ctx.query?.referenceId;\n\tif (customerType === \"organization\") {\n\t\tif (!subscriptionOptions.authorizeReference) {\n\t\t\tctx.context.logger.error(`Organization subscriptions require authorizeReference to be defined in your stripe plugin config.`);\n\t\t\tthrow new APIError$1(\"BAD_REQUEST\", { message: STRIPE_ERROR_CODES.ORGANIZATION_SUBSCRIPTION_NOT_ENABLED });\n\t\t}\n\t\tconst referenceId = explicitReferenceId || ctxSession.session.activeOrganizationId;\n\t\tif (!referenceId) throw new APIError$1(\"BAD_REQUEST\", { message: STRIPE_ERROR_CODES.ORGANIZATION_REFERENCE_ID_REQUIRED });\n\t\tif (!await subscriptionOptions.authorizeReference({\n\t\t\tuser: ctxSession.user,\n\t\t\tsession: ctxSession.session,\n\t\t\treferenceId,\n\t\t\taction\n\t\t}, ctx)) throw new APIError$1(\"UNAUTHORIZED\", { message: STRIPE_ERROR_CODES.UNAUTHORIZED });\n\t\treturn;\n\t}\n\tif (!explicitReferenceId) return;\n\tif (explicitReferenceId === ctxSession.user.id) return;\n\tif (!subscriptionOptions.authorizeReference) {\n\t\tctx.context.logger.error(`Passing referenceId into a subscription action isn't allowed if subscription.authorizeReference isn't defined in your stripe plugin config.`);\n\t\tthrow new APIError$1(\"BAD_REQUEST\", { message: STRIPE_ERROR_CODES.REFERENCE_ID_NOT_ALLOWED });\n\t}\n\tif (!await subscriptionOptions.authorizeReference({\n\t\tuser: ctxSession.user,\n\t\tsession: ctxSession.session,\n\t\treferenceId: explicitReferenceId,\n\t\taction\n\t}, ctx)) throw new APIError$1(\"UNAUTHORIZED\", { message: STRIPE_ERROR_CODES.UNAUTHORIZED });\n});\n\n//#endregion\n//#region src/routes.ts\n/**\n* Converts a relative URL to an absolute URL using baseURL.\n* @internal\n*/\nfunction getUrl(ctx, url) {\n\tif (/^[a-zA-Z][a-zA-Z0-9+\\-.]*:/.test(url)) return url;\n\treturn `${ctx.context.options.baseURL}${url.startsWith(\"/\") ? url : `/${url}`}`;\n}\n/**\n* Resolves a Stripe price ID from a lookup key.\n* @internal\n*/\nasync function resolvePriceIdFromLookupKey(stripeClient, lookupKey) {\n\tif (!lookupKey) return void 0;\n\treturn (await stripeClient.prices.list({\n\t\tlookup_keys: [lookupKey],\n\t\tactive: true,\n\t\tlimit: 1\n\t})).data[0]?.id;\n}\n/**\n* Determines the reference ID based on customer type.\n* - `user` (default): uses userId\n* - `organization`: uses activeOrganizationId from session\n* @internal\n*/\nfunction getReferenceId(ctxSession, customerType, options) {\n\tconst { user: user$1, session } = ctxSession;\n\tif ((customerType || \"user\") === \"organization\") {\n\t\tif (!options.organization?.enabled) throw new APIError$1(\"BAD_REQUEST\", { message: STRIPE_ERROR_CODES.ORGANIZATION_SUBSCRIPTION_NOT_ENABLED });\n\t\tif (!session.activeOrganizationId) throw new APIError$1(\"BAD_REQUEST\", { message: STRIPE_ERROR_CODES.ORGANIZATION_NOT_FOUND });\n\t\treturn session.activeOrganizationId;\n\t}\n\treturn user$1.id;\n}\nconst upgradeSubscriptionBodySchema = z.object({\n\tplan: z.string().meta({ description: \"The name of the plan to upgrade to. Eg: \\\"pro\\\"\" }),\n\tannual: z.boolean().meta({ description: \"Whether to upgrade to an annual plan. Eg: true\" }).optional(),\n\treferenceId: z.string().meta({ description: \"Reference ID for the subscription. Eg: \\\"org_123\\\"\" }).optional(),\n\tsubscriptionId: z.string().meta({ description: \"The Stripe subscription ID to upgrade. Eg: \\\"sub_1ABC2DEF3GHI4JKL\\\"\" }).optional(),\n\tcustomerType: z.enum([\"user\", \"organization\"]).meta({ description: \"Customer type for the subscription. Eg: \\\"user\\\" or \\\"organization\\\"\" }).optional(),\n\tmetadata: z.record(z.string(), z.any()).optional(),\n\tseats: z.number().meta({ description: \"Number of seats to upgrade to (if applicable). Eg: 1\" }).optional(),\n\tlocale: z.custom((localization) => {\n\t\treturn typeof localization === \"string\";\n\t}).meta({ description: \"The locale to display Checkout in. Eg: 'en', 'ko'. If not provided or set to `auto`, the browser's locale is used.\" }).optional(),\n\tsuccessUrl: z.string().meta({ description: \"Callback URL to redirect back after successful subscription. Eg: \\\"https://example.com/success\\\"\" }).default(\"/\"),\n\tcancelUrl: z.string().meta({ description: \"If set, checkout shows a back button and customers will be directed here if they cancel payment. Eg: \\\"https://example.com/pricing\\\"\" }).default(\"/\"),\n\treturnUrl: z.string().meta({ description: \"URL to take customers to when they click on the billing portalâ€™s link to return to your website. Eg: \\\"https://example.com/dashboard\\\"\" }).optional(),\n\tdisableRedirect: z.boolean().meta({ description: \"Disable redirect after successful subscription. Eg: true\" }).default(false)\n});\n/**\n* ### Endpoint\n*\n* POST `/subscription/upgrade`\n*\n* ### API Methods\n*\n* **server:**\n* `auth.api.upgradeSubscription`\n*\n* **client:**\n* `authClient.subscription.upgrade`\n*\n* @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/stripe#api-method-subscription-upgrade)\n*/\nconst upgradeSubscription = (options) => {\n\tconst client = options.stripeClient;\n\tconst subscriptionOptions = options.subscription;\n\treturn createAuthEndpoint(\"/subscription/upgrade\", {\n\t\tmethod: \"POST\",\n\t\tbody: upgradeSubscriptionBodySchema,\n\t\tmetadata: { openapi: { operationId: \"upgradeSubscription\" } },\n\t\tuse: [\n\t\t\tstripeSessionMiddleware,\n\t\t\treferenceMiddleware(subscriptionOptions, \"upgrade-subscription\"),\n\t\t\toriginCheck((c) => {\n\t\t\t\treturn [c.body.successUrl, c.body.cancelUrl];\n\t\t\t})\n\t\t]\n\t}, async (ctx) => {\n\t\tconst { user: user$1, session } = ctx.context.session;\n\t\tconst customerType = ctx.body.customerType || \"user\";\n\t\tconst referenceId = ctx.body.referenceId || getReferenceId(ctx.context.session, customerType, options);\n\t\tif (!user$1.emailVerified && subscriptionOptions.requireEmailVerification) throw new APIError$1(\"BAD_REQUEST\", { message: STRIPE_ERROR_CODES.EMAIL_VERIFICATION_REQUIRED });\n\t\tconst plan = await getPlanByName(options, ctx.body.plan);\n\t\tif (!plan) throw new APIError$1(\"BAD_REQUEST\", { message: STRIPE_ERROR_CODES.SUBSCRIPTION_PLAN_NOT_FOUND });\n\t\tlet subscriptionToUpdate = ctx.body.subscriptionId ? await ctx.context.adapter.findOne({\n\t\t\tmodel: \"subscription\",\n\t\t\twhere: [{\n\t\t\t\tfield: \"stripeSubscriptionId\",\n\t\t\t\tvalue: ctx.body.subscriptionId\n\t\t\t}]\n\t\t}) : referenceId ? await ctx.context.adapter.findOne({\n\t\t\tmodel: \"subscription\",\n\t\t\twhere: [{\n\t\t\t\tfield: \"referenceId\",\n\t\t\t\tvalue: referenceId\n\t\t\t}]\n\t\t}) : null;\n\t\tif (ctx.body.subscriptionId && subscriptionToUpdate && subscriptionToUpdate.referenceId !== referenceId) subscriptionToUpdate = null;\n\t\tif (ctx.body.subscriptionId && !subscriptionToUpdate) throw new APIError$1(\"BAD_REQUEST\", { message: STRIPE_ERROR_CODES.SUBSCRIPTION_NOT_FOUND });\n\t\tlet customerId;\n\t\tif (customerType === \"organization\") {\n\t\t\tcustomerId = subscriptionToUpdate?.stripeCustomerId;\n\t\t\tif (!customerId) {\n\t\t\t\tconst org = await ctx.context.adapter.findOne({\n\t\t\t\t\tmodel: \"organization\",\n\t\t\t\t\twhere: [{\n\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\tvalue: referenceId\n\t\t\t\t\t}]\n\t\t\t\t});\n\t\t\t\tif (!org) throw new APIError$1(\"BAD_REQUEST\", { message: STRIPE_ERROR_CODES.ORGANIZATION_NOT_FOUND });\n\t\t\t\tcustomerId = org.stripeCustomerId;\n\t\t\t\tif (!customerId) try {\n\t\t\t\t\tlet stripeCustomer = (await client.customers.search({\n\t\t\t\t\t\tquery: `metadata[\"organizationId\"]:\"${org.id}\"`,\n\t\t\t\t\t\tlimit: 1\n\t\t\t\t\t})).data[0];\n\t\t\t\t\tif (!stripeCustomer) {\n\t\t\t\t\t\tlet extraCreateParams = {};\n\t\t\t\t\t\tif (options.organization?.getCustomerCreateParams) extraCreateParams = await options.organization.getCustomerCreateParams(org, ctx);\n\t\t\t\t\t\tconst customerParams = defu({\n\t\t\t\t\t\t\tname: org.name,\n\t\t\t\t\t\t\tmetadata: {\n\t\t\t\t\t\t\t\t...ctx.body.metadata,\n\t\t\t\t\t\t\t\torganizationId: org.id,\n\t\t\t\t\t\t\t\tcustomerType: \"organization\"\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}, extraCreateParams);\n\t\t\t\t\t\tstripeCustomer = await client.customers.create(customerParams);\n\t\t\t\t\t\tawait options.organization?.onCustomerCreate?.({\n\t\t\t\t\t\t\tstripeCustomer,\n\t\t\t\t\t\t\torganization: {\n\t\t\t\t\t\t\t\t...org,\n\t\t\t\t\t\t\t\tstripeCustomerId: stripeCustomer.id\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}, ctx);\n\t\t\t\t\t}\n\t\t\t\t\tawait ctx.context.adapter.update({\n\t\t\t\t\t\tmodel: \"organization\",\n\t\t\t\t\t\tupdate: { stripeCustomerId: stripeCustomer.id },\n\t\t\t\t\t\twhere: [{\n\t\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\t\tvalue: org.id\n\t\t\t\t\t\t}]\n\t\t\t\t\t});\n\t\t\t\t\tcustomerId = stripeCustomer.id;\n\t\t\t\t} catch (e) {\n\t\t\t\t\tctx.context.logger.error(e);\n\t\t\t\t\tthrow new APIError$1(\"BAD_REQUEST\", { message: STRIPE_ERROR_CODES.UNABLE_TO_CREATE_CUSTOMER });\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tcustomerId = subscriptionToUpdate?.stripeCustomerId || user$1.stripeCustomerId;\n\t\t\tif (!customerId) try {\n\t\t\t\tlet stripeCustomer = (await client.customers.search({\n\t\t\t\t\tquery: `email:\"${escapeStripeSearchValue(user$1.email)}\" AND -metadata[\"customerType\"]:\"organization\"`,\n\t\t\t\t\tlimit: 1\n\t\t\t\t})).data[0];\n\t\t\t\tif (!stripeCustomer) stripeCustomer = await client.customers.create({\n\t\t\t\t\temail: user$1.email,\n\t\t\t\t\tname: user$1.name,\n\t\t\t\t\tmetadata: {\n\t\t\t\t\t\t...ctx.body.metadata,\n\t\t\t\t\t\tuserId: user$1.id,\n\t\t\t\t\t\tcustomerType: \"user\"\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tawait ctx.context.adapter.update({\n\t\t\t\t\tmodel: \"user\",\n\t\t\t\t\tupdate: { stripeCustomerId: stripeCustomer.id },\n\t\t\t\t\twhere: [{\n\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\tvalue: user$1.id\n\t\t\t\t\t}]\n\t\t\t\t});\n\t\t\t\tcustomerId = stripeCustomer.id;\n\t\t\t} catch (e) {\n\t\t\t\tctx.context.logger.error(e);\n\t\t\t\tthrow new APIError$1(\"BAD_REQUEST\", { message: STRIPE_ERROR_CODES.UNABLE_TO_CREATE_CUSTOMER });\n\t\t\t}\n\t\t}\n\t\tconst subscriptions$1 = subscriptionToUpdate ? [subscriptionToUpdate] : await ctx.context.adapter.findMany({\n\t\t\tmodel: \"subscription\",\n\t\t\twhere: [{\n\t\t\t\tfield: \"referenceId\",\n\t\t\t\tvalue: referenceId\n\t\t\t}]\n\t\t});\n\t\tconst activeOrTrialingSubscription = subscriptions$1.find((sub) => isActiveOrTrialing(sub));\n\t\tconst activeSubscription = (await client.subscriptions.list({ customer: customerId }).then((res) => res.data.filter((sub) => isActiveOrTrialing(sub)))).find((sub) => {\n\t\t\tif (subscriptionToUpdate?.stripeSubscriptionId || ctx.body.subscriptionId) return sub.id === subscriptionToUpdate?.stripeSubscriptionId || sub.id === ctx.body.subscriptionId;\n\t\t\tif (activeOrTrialingSubscription?.stripeSubscriptionId) return sub.id === activeOrTrialingSubscription.stripeSubscriptionId;\n\t\t\treturn false;\n\t\t});\n\t\tconst incompleteSubscription = subscriptions$1.find((sub) => sub.status === \"incomplete\");\n\t\tif (activeOrTrialingSubscription && activeOrTrialingSubscription.status === \"active\" && activeOrTrialingSubscription.plan === ctx.body.plan && activeOrTrialingSubscription.seats === (ctx.body.seats || 1)) throw new APIError$1(\"BAD_REQUEST\", { message: STRIPE_ERROR_CODES.ALREADY_SUBSCRIBED_PLAN });\n\t\tif (activeSubscription && customerId) {\n\t\t\tlet dbSubscription = await ctx.context.adapter.findOne({\n\t\t\t\tmodel: \"subscription\",\n\t\t\t\twhere: [{\n\t\t\t\t\tfield: \"stripeSubscriptionId\",\n\t\t\t\t\tvalue: activeSubscription.id\n\t\t\t\t}]\n\t\t\t});\n\t\t\tif (!dbSubscription && activeOrTrialingSubscription) {\n\t\t\t\tawait ctx.context.adapter.update({\n\t\t\t\t\tmodel: \"subscription\",\n\t\t\t\t\tupdate: {\n\t\t\t\t\t\tstripeSubscriptionId: activeSubscription.id,\n\t\t\t\t\t\tupdatedAt: /* @__PURE__ */ new Date()\n\t\t\t\t\t},\n\t\t\t\t\twhere: [{\n\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\tvalue: activeOrTrialingSubscription.id\n\t\t\t\t\t}]\n\t\t\t\t});\n\t\t\t\tdbSubscription = activeOrTrialingSubscription;\n\t\t\t}\n\t\t\tlet priceIdToUse$1 = void 0;\n\t\t\tif (ctx.body.annual) {\n\t\t\t\tpriceIdToUse$1 = plan.annualDiscountPriceId;\n\t\t\t\tif (!priceIdToUse$1 && plan.annualDiscountLookupKey) priceIdToUse$1 = await resolvePriceIdFromLookupKey(client, plan.annualDiscountLookupKey);\n\t\t\t} else {\n\t\t\t\tpriceIdToUse$1 = plan.priceId;\n\t\t\t\tif (!priceIdToUse$1 && plan.lookupKey) priceIdToUse$1 = await resolvePriceIdFromLookupKey(client, plan.lookupKey);\n\t\t\t}\n\t\t\tif (!priceIdToUse$1) throw ctx.error(\"BAD_REQUEST\", { message: \"Price ID not found for the selected plan\" });\n\t\t\tconst { url } = await client.billingPortal.sessions.create({\n\t\t\t\tcustomer: customerId,\n\t\t\t\treturn_url: getUrl(ctx, ctx.body.returnUrl || \"/\"),\n\t\t\t\tflow_data: {\n\t\t\t\t\ttype: \"subscription_update_confirm\",\n\t\t\t\t\tafter_completion: {\n\t\t\t\t\t\ttype: \"redirect\",\n\t\t\t\t\t\tredirect: { return_url: getUrl(ctx, ctx.body.returnUrl || \"/\") }\n\t\t\t\t\t},\n\t\t\t\t\tsubscription_update_confirm: {\n\t\t\t\t\t\tsubscription: activeSubscription.id,\n\t\t\t\t\t\titems: [{\n\t\t\t\t\t\t\tid: activeSubscription.items.data[0]?.id,\n\t\t\t\t\t\t\tquantity: ctx.body.seats || 1,\n\t\t\t\t\t\t\tprice: priceIdToUse$1\n\t\t\t\t\t\t}]\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}).catch(async (e) => {\n\t\t\t\tthrow ctx.error(\"BAD_REQUEST\", {\n\t\t\t\t\tmessage: e.message,\n\t\t\t\t\tcode: e.code\n\t\t\t\t});\n\t\t\t});\n\t\t\treturn ctx.json({\n\t\t\t\turl,\n\t\t\t\tredirect: !ctx.body.disableRedirect\n\t\t\t});\n\t\t}\n\t\tlet subscription = activeOrTrialingSubscription || incompleteSubscription;\n\t\tif (incompleteSubscription && !activeOrTrialingSubscription) subscription = await ctx.context.adapter.update({\n\t\t\tmodel: \"subscription\",\n\t\t\tupdate: {\n\t\t\t\tplan: plan.name.toLowerCase(),\n\t\t\t\tseats: ctx.body.seats || 1,\n\t\t\t\tupdatedAt: /* @__PURE__ */ new Date()\n\t\t\t},\n\t\t\twhere: [{\n\t\t\t\tfield: \"id\",\n\t\t\t\tvalue: incompleteSubscription.id\n\t\t\t}]\n\t\t}) || incompleteSubscription;\n\t\tif (!subscription) subscription = await ctx.context.adapter.create({\n\t\t\tmodel: \"subscription\",\n\t\t\tdata: {\n\t\t\t\tplan: plan.name.toLowerCase(),\n\t\t\t\tstripeCustomerId: customerId,\n\t\t\t\tstatus: \"incomplete\",\n\t\t\t\treferenceId,\n\t\t\t\tseats: ctx.body.seats || 1\n\t\t\t}\n\t\t});\n\t\tif (!subscription) {\n\t\t\tctx.context.logger.error(\"Subscription ID not found\");\n\t\t\tthrow new APIError$1(\"NOT_FOUND\", { message: STRIPE_ERROR_CODES.SUBSCRIPTION_NOT_FOUND });\n\t\t}\n\t\tconst params = await subscriptionOptions.getCheckoutSessionParams?.({\n\t\t\tuser: user$1,\n\t\t\tsession,\n\t\t\tplan,\n\t\t\tsubscription\n\t\t}, ctx.request, ctx);\n\t\tconst freeTrial = !(await ctx.context.adapter.findMany({\n\t\t\tmodel: \"subscription\",\n\t\t\twhere: [{\n\t\t\t\tfield: \"referenceId\",\n\t\t\t\tvalue: referenceId\n\t\t\t}]\n\t\t})).some((s) => {\n\t\t\treturn !!(s.trialStart || s.trialEnd) || s.status === \"trialing\";\n\t\t}) && plan.freeTrial ? { trial_period_days: plan.freeTrial.days } : void 0;\n\t\tlet priceIdToUse = void 0;\n\t\tif (ctx.body.annual) {\n\t\t\tpriceIdToUse = plan.annualDiscountPriceId;\n\t\t\tif (!priceIdToUse && plan.annualDiscountLookupKey) priceIdToUse = await resolvePriceIdFromLookupKey(client, plan.annualDiscountLookupKey);\n\t\t} else {\n\t\t\tpriceIdToUse = plan.priceId;\n\t\t\tif (!priceIdToUse && plan.lookupKey) priceIdToUse = await resolvePriceIdFromLookupKey(client, plan.lookupKey);\n\t\t}\n\t\tconst checkoutSession = await client.checkout.sessions.create({\n\t\t\t...customerId ? {\n\t\t\t\tcustomer: customerId,\n\t\t\t\tcustomer_update: customerType !== \"user\" ? { address: \"auto\" } : {\n\t\t\t\t\tname: \"auto\",\n\t\t\t\t\taddress: \"auto\"\n\t\t\t\t}\n\t\t\t} : { customer_email: user$1.email },\n\t\t\tlocale: ctx.body.locale,\n\t\t\tsuccess_url: getUrl(ctx, `${ctx.context.baseURL}/subscription/success?callbackURL=${encodeURIComponent(ctx.body.successUrl)}&subscriptionId=${encodeURIComponent(subscription.id)}`),\n\t\t\tcancel_url: getUrl(ctx, ctx.body.cancelUrl),\n\t\t\tline_items: [{\n\t\t\t\tprice: priceIdToUse,\n\t\t\t\tquantity: ctx.body.seats || 1\n\t\t\t}],\n\t\t\tsubscription_data: {\n\t\t\t\t...freeTrial,\n\t\t\t\tmetadata: {\n\t\t\t\t\t...ctx.body.metadata,\n\t\t\t\t\t...params?.params?.subscription_data?.metadata,\n\t\t\t\t\tuserId: user$1.id,\n\t\t\t\t\tsubscriptionId: subscription.id,\n\t\t\t\t\treferenceId\n\t\t\t\t}\n\t\t\t},\n\t\t\tmode: \"subscription\",\n\t\t\tclient_reference_id: referenceId,\n\t\t\t...params?.params,\n\t\t\tmetadata: {\n\t\t\t\t...ctx.body.metadata,\n\t\t\t\t...params?.params?.metadata,\n\t\t\t\tuserId: user$1.id,\n\t\t\t\tsubscriptionId: subscription.id,\n\t\t\t\treferenceId\n\t\t\t}\n\t\t}, params?.options).catch(async (e) => {\n\t\t\tthrow ctx.error(\"BAD_REQUEST\", {\n\t\t\t\tmessage: e.message,\n\t\t\t\tcode: e.code\n\t\t\t});\n\t\t});\n\t\treturn ctx.json({\n\t\t\t...checkoutSession,\n\t\t\tredirect: !ctx.body.disableRedirect\n\t\t});\n\t});\n};\nconst cancelSubscriptionCallbackQuerySchema = z.record(z.string(), z.any()).optional();\nconst cancelSubscriptionCallback = (options) => {\n\tconst client = options.stripeClient;\n\tconst subscriptionOptions = options.subscription;\n\treturn createAuthEndpoint(\"/subscription/cancel/callback\", {\n\t\tmethod: \"GET\",\n\t\tquery: cancelSubscriptionCallbackQuerySchema,\n\t\tmetadata: { openapi: { operationId: \"cancelSubscriptionCallback\" } },\n\t\tuse: [originCheck((ctx) => ctx.query.callbackURL)]\n\t}, async (ctx) => {\n\t\tif (!ctx.query || !ctx.query.callbackURL || !ctx.query.subscriptionId) throw ctx.redirect(getUrl(ctx, ctx.query?.callbackURL || \"/\"));\n\t\tconst session = await getSessionFromCtx(ctx);\n\t\tif (!session) throw ctx.redirect(getUrl(ctx, ctx.query?.callbackURL || \"/\"));\n\t\tconst { user: user$1 } = session;\n\t\tconst { callbackURL, subscriptionId } = ctx.query;\n\t\tif (user$1?.stripeCustomerId) try {\n\t\t\tconst subscription = await ctx.context.adapter.findOne({\n\t\t\t\tmodel: \"subscription\",\n\t\t\t\twhere: [{\n\t\t\t\t\tfield: \"id\",\n\t\t\t\t\tvalue: subscriptionId\n\t\t\t\t}]\n\t\t\t});\n\t\t\tif (!subscription || subscription.status === \"canceled\" || isPendingCancel(subscription)) throw ctx.redirect(getUrl(ctx, callbackURL));\n\t\t\tconst currentSubscription = (await client.subscriptions.list({\n\t\t\t\tcustomer: user$1.stripeCustomerId,\n\t\t\t\tstatus: \"active\"\n\t\t\t})).data.find((sub) => sub.id === subscription.stripeSubscriptionId);\n\t\t\tif (currentSubscription && isStripePendingCancel(currentSubscription) && !isPendingCancel(subscription)) {\n\t\t\t\tawait ctx.context.adapter.update({\n\t\t\t\t\tmodel: \"subscription\",\n\t\t\t\t\tupdate: {\n\t\t\t\t\t\tstatus: currentSubscription?.status,\n\t\t\t\t\t\tcancelAtPeriodEnd: currentSubscription?.cancel_at_period_end || false,\n\t\t\t\t\t\tcancelAt: currentSubscription?.cancel_at ? /* @__PURE__ */ new Date(currentSubscription.cancel_at * 1e3) : null,\n\t\t\t\t\t\tcanceledAt: currentSubscription?.canceled_at ? /* @__PURE__ */ new Date(currentSubscription.canceled_at * 1e3) : null\n\t\t\t\t\t},\n\t\t\t\t\twhere: [{\n\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\tvalue: subscription.id\n\t\t\t\t\t}]\n\t\t\t\t});\n\t\t\t\tawait subscriptionOptions.onSubscriptionCancel?.({\n\t\t\t\t\tsubscription,\n\t\t\t\t\tcancellationDetails: currentSubscription.cancellation_details,\n\t\t\t\t\tstripeSubscription: currentSubscription,\n\t\t\t\t\tevent: void 0\n\t\t\t\t});\n\t\t\t}\n\t\t} catch (error) {\n\t\t\tctx.context.logger.error(\"Error checking subscription status from Stripe\", error);\n\t\t}\n\t\tthrow ctx.redirect(getUrl(ctx, callbackURL));\n\t});\n};\nconst cancelSubscriptionBodySchema = z.object({\n\treferenceId: z.string().meta({ description: \"Reference id of the subscription to cancel. Eg: '123'\" }).optional(),\n\tsubscriptionId: z.string().meta({ description: \"The Stripe subscription ID to cancel. Eg: 'sub_1ABC2DEF3GHI4JKL'\" }).optional(),\n\tcustomerType: z.enum([\"user\", \"organization\"]).meta({ description: \"Customer type for the subscription. Eg: \\\"user\\\" or \\\"organization\\\"\" }).optional(),\n\treturnUrl: z.string().meta({ description: \"URL to take customers to when they click on the billing portal's link to return to your website. Eg: \\\"/account\\\"\" }),\n\tdisableRedirect: z.boolean().meta({ description: \"Disable redirect after successful subscription cancellation. Eg: true\" }).default(false)\n});\n/**\n* ### Endpoint\n*\n* POST `/subscription/cancel`\n*\n* ### API Methods\n*\n* **server:**\n* `auth.api.cancelSubscription`\n*\n* **client:**\n* `authClient.subscription.cancel`\n*\n* @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/stripe#api-method-subscription-cancel)\n*/\nconst cancelSubscription = (options) => {\n\tconst client = options.stripeClient;\n\tconst subscriptionOptions = options.subscription;\n\treturn createAuthEndpoint(\"/subscription/cancel\", {\n\t\tmethod: \"POST\",\n\t\tbody: cancelSubscriptionBodySchema,\n\t\tmetadata: { openapi: { operationId: \"cancelSubscription\" } },\n\t\tuse: [\n\t\t\tstripeSessionMiddleware,\n\t\t\treferenceMiddleware(subscriptionOptions, \"cancel-subscription\"),\n\t\t\toriginCheck((ctx) => ctx.body.returnUrl)\n\t\t]\n\t}, async (ctx) => {\n\t\tconst customerType = ctx.body.customerType || \"user\";\n\t\tconst referenceId = ctx.body.referenceId || getReferenceId(ctx.context.session, customerType, options);\n\t\tlet subscription = ctx.body.subscriptionId ? await ctx.context.adapter.findOne({\n\t\t\tmodel: \"subscription\",\n\t\t\twhere: [{\n\t\t\t\tfield: \"stripeSubscriptionId\",\n\t\t\t\tvalue: ctx.body.subscriptionId\n\t\t\t}]\n\t\t}) : await ctx.context.adapter.findMany({\n\t\t\tmodel: \"subscription\",\n\t\t\twhere: [{\n\t\t\t\tfield: \"referenceId\",\n\t\t\t\tvalue: referenceId\n\t\t\t}]\n\t\t}).then((subs) => subs.find((sub) => isActiveOrTrialing(sub)));\n\t\tif (ctx.body.subscriptionId && subscription && subscription.referenceId !== referenceId) subscription = void 0;\n\t\tif (!subscription || !subscription.stripeCustomerId) throw ctx.error(\"BAD_REQUEST\", { message: STRIPE_ERROR_CODES.SUBSCRIPTION_NOT_FOUND });\n\t\tconst activeSubscriptions = await client.subscriptions.list({ customer: subscription.stripeCustomerId }).then((res) => res.data.filter((sub) => isActiveOrTrialing(sub)));\n\t\tif (!activeSubscriptions.length) {\n\t\t\t/**\n\t\t\t* If the subscription is not found, we need to delete the subscription\n\t\t\t* from the database. This is a rare case and should not happen.\n\t\t\t*/\n\t\t\tawait ctx.context.adapter.deleteMany({\n\t\t\t\tmodel: \"subscription\",\n\t\t\t\twhere: [{\n\t\t\t\t\tfield: \"referenceId\",\n\t\t\t\t\tvalue: referenceId\n\t\t\t\t}]\n\t\t\t});\n\t\t\tthrow ctx.error(\"BAD_REQUEST\", { message: STRIPE_ERROR_CODES.SUBSCRIPTION_NOT_FOUND });\n\t\t}\n\t\tconst activeSubscription = activeSubscriptions.find((sub) => sub.id === subscription.stripeSubscriptionId);\n\t\tif (!activeSubscription) throw ctx.error(\"BAD_REQUEST\", { message: STRIPE_ERROR_CODES.SUBSCRIPTION_NOT_FOUND });\n\t\tconst { url } = await client.billingPortal.sessions.create({\n\t\t\tcustomer: subscription.stripeCustomerId,\n\t\t\treturn_url: getUrl(ctx, `${ctx.context.baseURL}/subscription/cancel/callback?callbackURL=${encodeURIComponent(ctx.body?.returnUrl || \"/\")}&subscriptionId=${encodeURIComponent(subscription.id)}`),\n\t\t\tflow_data: {\n\t\t\t\ttype: \"subscription_cancel\",\n\t\t\t\tsubscription_cancel: { subscription: activeSubscription.id }\n\t\t\t}\n\t\t}).catch(async (e) => {\n\t\t\tif (e.message?.includes(\"already set to be canceled\")) {\n\t\t\t\t/**\n\t\t\t\t* in-case we missed the event from stripe, we sync the actual state\n\t\t\t\t* this is a rare case and should not happen\n\t\t\t\t*/\n\t\t\t\tif (!isPendingCancel(subscription)) {\n\t\t\t\t\tconst stripeSub = await client.subscriptions.retrieve(activeSubscription.id);\n\t\t\t\t\tawait ctx.context.adapter.update({\n\t\t\t\t\t\tmodel: \"subscription\",\n\t\t\t\t\t\tupdate: {\n\t\t\t\t\t\t\tcancelAtPeriodEnd: stripeSub.cancel_at_period_end,\n\t\t\t\t\t\t\tcancelAt: stripeSub.cancel_at ? /* @__PURE__ */ new Date(stripeSub.cancel_at * 1e3) : null,\n\t\t\t\t\t\t\tcanceledAt: stripeSub.canceled_at ? /* @__PURE__ */ new Date(stripeSub.canceled_at * 1e3) : null\n\t\t\t\t\t\t},\n\t\t\t\t\t\twhere: [{\n\t\t\t\t\t\t\tfield: \"id\",\n\t\t\t\t\t\t\tvalue: subscription.id\n\t\t\t\t\t\t}]\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t\tthrow ctx.error(\"BAD_REQUEST\", {\n\t\t\t\tmessage: e.message,\n\t\t\t\tcode: e.code\n\t\t\t});\n\t\t});\n\t\treturn ctx.json({\n\t\t\turl,\n\t\t\tredirect: !ctx.body.disableRedirect\n\t\t});\n\t});\n};\nconst restoreSubscriptionBodySchema = z.object({\n\treferenceId: z.string().meta({ description: \"Reference id of the subscription to restore. Eg: '123'\" }).optional(),\n\tsubscriptionId: z.string().meta({ description: \"The Stripe subscription ID to restore. Eg: 'sub_1ABC2DEF3GHI4JKL'\" }).optional(),\n\tcustomerType: z.enum([\"user\", \"organization\"]).meta({ description: \"Customer type for the subscription. Eg: \\\"user\\\" or \\\"organization\\\"\" }).optional()\n});\nconst restoreSubscription = (options) => {\n\tconst client = options.stripeClient;\n\tconst subscriptionOptions = options.subscription;\n\treturn createAuthEndpoint(\"/subscription/restore\", {\n\t\tmethod: \"POST\",\n\t\tbody: restoreSubscriptionBodySchema,\n\t\tmetadata: { openapi: { operationId: \"restoreSubscription\" } },\n\t\tuse: [stripeSessionMiddleware, referenceMiddleware(subscriptionOptions, \"restore-subscription\")]\n\t}, async (ctx) => {\n\t\tconst customerType = ctx.body.customerType || \"user\";\n\t\tconst referenceId = ctx.body.referenceId || getReferenceId(ctx.context.session, customerType, options);\n\t\tlet subscription = ctx.body.subscriptionId ? await ctx.context.adapter.findOne({\n\t\t\tmodel: \"subscription\",\n\t\t\twhere: [{\n\t\t\t\tfield: \"stripeSubscriptionId\",\n\t\t\t\tvalue: ctx.body.subscriptionId\n\t\t\t}]\n\t\t}) : await ctx.context.adapter.findMany({\n\t\t\tmodel: \"subscription\",\n\t\t\twhere: [{\n\t\t\t\tfield: \"referenceId\",\n\t\t\t\tvalue: referenceId\n\t\t\t}]\n\t\t}).then((subs) => subs.find((sub) => isActiveOrTrialing(sub)));\n\t\tif (ctx.body.subscriptionId && subscription && subscription.referenceId !== referenceId) subscription = void 0;\n\t\tif (!subscription || !subscription.stripeCustomerId) throw ctx.error(\"BAD_REQUEST\", { message: STRIPE_ERROR_CODES.SUBSCRIPTION_NOT_FOUND });\n\t\tif (!isActiveOrTrialing(subscription)) throw ctx.error(\"BAD_REQUEST\", { message: STRIPE_ERROR_CODES.SUBSCRIPTION_NOT_ACTIVE });\n\t\tif (!isPendingCancel(subscription)) throw ctx.error(\"BAD_REQUEST\", { message: STRIPE_ERROR_CODES.SUBSCRIPTION_NOT_SCHEDULED_FOR_CANCELLATION });\n\t\tconst activeSubscription = await client.subscriptions.list({ customer: subscription.stripeCustomerId }).then((res) => res.data.filter((sub) => isActiveOrTrialing(sub))[0]);\n\t\tif (!activeSubscription) throw ctx.error(\"BAD_REQUEST\", { message: STRIPE_ERROR_CODES.SUBSCRIPTION_NOT_FOUND });\n\t\tconst updateParams = {};\n\t\tif (activeSubscription.cancel_at) updateParams.cancel_at = \"\";\n\t\telse if (activeSubscription.cancel_at_period_end) updateParams.cancel_at_period_end = false;\n\t\tconst newSub = await client.subscriptions.update(activeSubscription.id, updateParams).catch((e) => {\n\t\t\tthrow ctx.error(\"BAD_REQUEST\", {\n\t\t\t\tmessage: e.message,\n\t\t\t\tcode: e.code\n\t\t\t});\n\t\t});\n\t\tawait ctx.context.adapter.update({\n\t\t\tmodel: \"subscription\",\n\t\t\tupdate: {\n\t\t\t\tcancelAtPeriodEnd: false,\n\t\t\t\tcancelAt: null,\n\t\t\t\tcanceledAt: null,\n\t\t\t\tupdatedAt: /* @__PURE__ */ new Date()\n\t\t\t},\n\t\t\twhere: [{\n\t\t\t\tfield: \"id\",\n\t\t\t\tvalue: subscription.id\n\t\t\t}]\n\t\t});\n\t\treturn ctx.json(newSub);\n\t});\n};\nconst listActiveSubscriptionsQuerySchema = z.optional(z.object({\n\treferenceId: z.string().meta({ description: \"Reference id of the subscription to list. Eg: '123'\" }).optional(),\n\tcustomerType: z.enum([\"user\", \"organization\"]).meta({ description: \"Customer type for the subscription. Eg: \\\"user\\\" or \\\"organization\\\"\" }).optional()\n}));\n/**\n* ### Endpoint\n*\n* GET `/subscription/list`\n*\n* ### API Methods\n*\n* **server:**\n* `auth.api.listActiveSubscriptions`\n*\n* **client:**\n* `authClient.subscription.list`\n*\n* @see [Read our docs to learn more.](https://better-auth.com/docs/plugins/stripe#api-method-subscription-list)\n*/\nconst listActiveSubscriptions = (options) => {\n\tconst subscriptionOptions = options.subscription;\n\treturn createAuthEndpoint(\"/subscription/list\", {\n\t\tmethod: \"GET\",\n\t\tquery: listActiveSubscriptionsQuerySchema,\n\t\tmetadata: { openapi: { operationId: \"listActiveSubscriptions\" } },\n\t\tuse: [stripeSessionMiddleware, referenceMiddleware(subscriptionOptions, \"list-subscription\")]\n\t}, async (ctx) => {\n\t\tconst customerType = ctx.query?.customerType || \"user\";\n\t\tconst referenceId = ctx.query?.referenceId || getReferenceId(ctx.context.session, customerType, options);\n\t\tconst subscriptions$1 = await ctx.context.adapter.findMany({\n\t\t\tmodel: \"subscription\",\n\t\t\twhere: [{\n\t\t\t\tfield: \"referenceId\",\n\t\t\t\tvalue: referenceId\n\t\t\t}]\n\t\t});\n\t\tif (!subscriptions$1.length) return [];\n\t\tconst plans = await getPlans(options.subscription);\n\t\tif (!plans) return [];\n\t\tconst subs = subscriptions$1.map((sub) => {\n\t\t\tconst plan = plans.find((p) => p.name.toLowerCase() === sub.plan.toLowerCase());\n\t\t\treturn {\n\t\t\t\t...sub,\n\t\t\t\tlimits: plan?.limits,\n\t\t\t\tpriceId: plan?.priceId\n\t\t\t};\n\t\t}).filter((sub) => isActiveOrTrialing(sub));\n\t\treturn ctx.json(subs);\n\t});\n};\nconst subscriptionSuccessQuerySchema = z.record(z.string(), z.any()).optional();\nconst subscriptionSuccess = (options) => {\n\tconst client = options.stripeClient;\n\treturn createAuthEndpoint(\"/subscription/success\", {\n\t\tmethod: \"GET\",\n\t\tquery: subscriptionSuccessQuerySchema,\n\t\tmetadata: { openapi: { operationId: \"handleSubscriptionSuccess\" } },\n\t\tuse: [originCheck((ctx) => ctx.query.callbackURL)]\n\t}, async (ctx) => {\n\t\tif (!ctx.query || !ctx.query.callbackURL || !ctx.query.subscriptionId) throw ctx.redirect(getUrl(ctx, ctx.query?.callbackURL || \"/\"));\n\t\tconst { callbackURL, subscriptionId } = ctx.query;\n\t\tconst session = await getSessionFromCtx(ctx);\n\t\tif (!session) throw ctx.redirect(getUrl(ctx, ctx.query?.callbackURL || \"/\"));\n\t\tconst subscription = await ctx.context.adapter.findOne({\n\t\t\tmodel: \"subscription\",\n\t\t\twhere: [{\n\t\t\t\tfield: \"id\",\n\t\t\t\tvalue: subscriptionId\n\t\t\t}]\n\t\t});\n\t\tif (!subscription) {\n\t\t\tctx.context.logger.warn(`Subscription record not found for subscriptionId: ${subscriptionId}`);\n\t\t\tthrow ctx.redirect(getUrl(ctx, callbackURL));\n\t\t}\n\t\tif (isActiveOrTrialing(subscription)) throw ctx.redirect(getUrl(ctx, callbackURL));\n\t\tconst customerId = subscription.stripeCustomerId || session.user.stripeCustomerId;\n\t\tif (!customerId) throw ctx.redirect(getUrl(ctx, callbackURL));\n\t\tconst stripeSubscription = await client.subscriptions.list({\n\t\t\tcustomer: customerId,\n\t\t\tstatus: \"active\"\n\t\t}).then((res) => res.data[0]).catch((error) => {\n\t\t\tctx.context.logger.error(\"Error fetching subscription from Stripe\", error);\n\t\t\tthrow ctx.redirect(getUrl(ctx, callbackURL));\n\t\t});\n\t\tif (!stripeSubscription) throw ctx.redirect(getUrl(ctx, callbackURL));\n\t\tconst subscriptionItem = stripeSubscription.items.data[0];\n\t\tif (!subscriptionItem) {\n\t\t\tctx.context.logger.warn(`No subscription items found for Stripe subscription ${stripeSubscription.id}`);\n\t\t\tthrow ctx.redirect(getUrl(ctx, callbackURL));\n\t\t}\n\t\tconst plan = await getPlanByPriceInfo(options, subscriptionItem.price.id, subscriptionItem.price.lookup_key);\n\t\tif (!plan) {\n\t\t\tctx.context.logger.warn(`Plan not found for price ${subscriptionItem.price.id}`);\n\t\t\tthrow ctx.redirect(getUrl(ctx, callbackURL));\n\t\t}\n\t\tawait ctx.context.adapter.update({\n\t\t\tmodel: \"subscription\",\n\t\t\tupdate: {\n\t\t\t\tstatus: stripeSubscription.status,\n\t\t\t\tseats: subscriptionItem.quantity || 1,\n\t\t\t\tplan: plan.name.toLowerCase(),\n\t\t\t\tperiodEnd: /* @__PURE__ */ new Date(subscriptionItem.current_period_end * 1e3),\n\t\t\t\tperiodStart: /* @__PURE__ */ new Date(subscriptionItem.current_period_start * 1e3),\n\t\t\t\tstripeSubscriptionId: stripeSubscription.id,\n\t\t\t\tcancelAtPeriodEnd: stripeSubscription.cancel_at_period_end,\n\t\t\t\tcancelAt: stripeSubscription.cancel_at ? /* @__PURE__ */ new Date(stripeSubscription.cancel_at * 1e3) : null,\n\t\t\t\tcanceledAt: stripeSubscription.canceled_at ? /* @__PURE__ */ new Date(stripeSubscription.canceled_at * 1e3) : null,\n\t\t\t\t...stripeSubscription.trial_start && stripeSubscription.trial_end ? {\n\t\t\t\t\ttrialStart: /* @__PURE__ */ new Date(stripeSubscription.trial_start * 1e3),\n\t\t\t\t\ttrialEnd: /* @__PURE__ */ new Date(stripeSubscription.trial_end * 1e3)\n\t\t\t\t} : {}\n\t\t\t},\n\t\t\twhere: [{\n\t\t\t\tfield: \"id\",\n\t\t\t\tvalue: subscription.id\n\t\t\t}]\n\t\t});\n\t\tthrow ctx.redirect(getUrl(ctx, callbackURL));\n\t});\n};\nconst createBillingPortalBodySchema = z.object({\n\tlocale: z.custom((localization) => {\n\t\treturn typeof localization === \"string\";\n\t}).meta({ description: \"The IETF language tag of the locale Customer Portal is displayed in. Eg: 'en', 'ko'. If not provided or set to `auto`, the browser's locale is used.\" }).optional(),\n\treferenceId: z.string().optional(),\n\tcustomerType: z.enum([\"user\", \"organization\"]).meta({ description: \"Customer type for the subscription. Eg: \\\"user\\\" or \\\"organization\\\"\" }).optional(),\n\treturnUrl: z.string().default(\"/\"),\n\tdisableRedirect: z.boolean().meta({ description: \"Disable redirect after creating billing portal session. Eg: true\" }).default(false)\n});\nconst createBillingPortal = (options) => {\n\tconst client = options.stripeClient;\n\tconst subscriptionOptions = options.subscription;\n\treturn createAuthEndpoint(\"/subscription/billing-portal\", {\n\t\tmethod: \"POST\",\n\t\tbody: createBillingPortalBodySchema,\n\t\tmetadata: { openapi: { operationId: \"createBillingPortal\" } },\n\t\tuse: [\n\t\t\tstripeSessionMiddleware,\n\t\t\treferenceMiddleware(subscriptionOptions, \"billing-portal\"),\n\t\t\toriginCheck((ctx) => ctx.body.returnUrl)\n\t\t]\n\t}, async (ctx) => {\n\t\tconst { user: user$1 } = ctx.context.session;\n\t\tconst customerType = ctx.body.customerType || \"user\";\n\t\tconst referenceId = ctx.body.referenceId || getReferenceId(ctx.context.session, customerType, options);\n\t\tlet customerId;\n\t\tif (customerType === \"organization\") {\n\t\t\tcustomerId = (await ctx.context.adapter.findOne({\n\t\t\t\tmodel: \"organization\",\n\t\t\t\twhere: [{\n\t\t\t\t\tfield: \"id\",\n\t\t\t\t\tvalue: referenceId\n\t\t\t\t}]\n\t\t\t}))?.stripeCustomerId;\n\t\t\tif (!customerId) customerId = (await ctx.context.adapter.findMany({\n\t\t\t\tmodel: \"subscription\",\n\t\t\t\twhere: [{\n\t\t\t\t\tfield: \"referenceId\",\n\t\t\t\t\tvalue: referenceId\n\t\t\t\t}]\n\t\t\t}).then((subs) => subs.find((sub) => isActiveOrTrialing(sub))))?.stripeCustomerId;\n\t\t} else {\n\t\t\tcustomerId = user$1.stripeCustomerId;\n\t\t\tif (!customerId) customerId = (await ctx.context.adapter.findMany({\n\t\t\t\tmodel: \"subscription\",\n\t\t\t\twhere: [{\n\t\t\t\t\tfield: \"referenceId\",\n\t\t\t\t\tvalue: referenceId\n\t\t\t\t}]\n\t\t\t}).then((subs) => subs.find((sub) => isActiveOrTrialing(sub))))?.stripeCustomerId;\n\t\t}\n\t\tif (!customerId) throw new APIError$1(\"NOT_FOUND\", { message: STRIPE_ERROR_CODES.CUSTOMER_NOT_FOUND });\n\t\ttry {\n\t\t\tconst { url } = await client.billingPortal.sessions.create({\n\t\t\t\tlocale: ctx.body.locale,\n\t\t\t\tcustomer: customerId,\n\t\t\t\treturn_url: getUrl(ctx, ctx.body.returnUrl)\n\t\t\t});\n\t\t\treturn ctx.json({\n\t\t\t\turl,\n\t\t\t\tredirect: !ctx.body.disableRedirect\n\t\t\t});\n\t\t} catch (error) {\n\t\t\tctx.context.logger.error(\"Error creating billing portal session\", error);\n\t\t\tthrow new APIError$1(\"INTERNAL_SERVER_ERROR\", { message: STRIPE_ERROR_CODES.UNABLE_TO_CREATE_BILLING_PORTAL });\n\t\t}\n\t});\n};\nconst stripeWebhook = (options) => {\n\tconst client = options.stripeClient;\n\treturn createAuthEndpoint(\"/stripe/webhook\", {\n\t\tmethod: \"POST\",\n\t\tmetadata: {\n\t\t\t...HIDE_METADATA,\n\t\t\topenapi: { operationId: \"handleStripeWebhook\" }\n\t\t},\n\t\tcloneRequest: true,\n\t\tdisableBody: true\n\t}, async (ctx) => {\n\t\tif (!ctx.request?.body) throw new APIError$1(\"BAD_REQUEST\", { message: STRIPE_ERROR_CODES.INVALID_REQUEST_BODY });\n\t\tconst sig = ctx.request.headers.get(\"stripe-signature\");\n\t\tif (!sig) throw new APIError$1(\"BAD_REQUEST\", { message: STRIPE_ERROR_CODES.STRIPE_SIGNATURE_NOT_FOUND });\n\t\tconst webhookSecret = options.stripeWebhookSecret;\n\t\tif (!webhookSecret) throw new APIError$1(\"INTERNAL_SERVER_ERROR\", { message: STRIPE_ERROR_CODES.STRIPE_WEBHOOK_SECRET_NOT_FOUND });\n\t\tconst payload = await ctx.request.text();\n\t\tlet event;\n\t\ttry {\n\t\t\tif (typeof client.webhooks.constructEventAsync === \"function\") event = await client.webhooks.constructEventAsync(payload, sig, webhookSecret);\n\t\t\telse event = client.webhooks.constructEvent(payload, sig, webhookSecret);\n\t\t} catch (err) {\n\t\t\tctx.context.logger.error(`${err.message}`);\n\t\t\tthrow new APIError$1(\"BAD_REQUEST\", { message: STRIPE_ERROR_CODES.FAILED_TO_CONSTRUCT_STRIPE_EVENT });\n\t\t}\n\t\tif (!event) throw new APIError$1(\"BAD_REQUEST\", { message: STRIPE_ERROR_CODES.FAILED_TO_CONSTRUCT_STRIPE_EVENT });\n\t\ttry {\n\t\t\tswitch (event.type) {\n\t\t\t\tcase \"checkout.session.completed\":\n\t\t\t\t\tawait onCheckoutSessionCompleted(ctx, options, event);\n\t\t\t\t\tawait options.onEvent?.(event);\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"customer.subscription.created\":\n\t\t\t\t\tawait onSubscriptionCreated(ctx, options, event);\n\t\t\t\t\tawait options.onEvent?.(event);\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"customer.subscription.updated\":\n\t\t\t\t\tawait onSubscriptionUpdated(ctx, options, event);\n\t\t\t\t\tawait options.onEvent?.(event);\n\t\t\t\t\tbreak;\n\t\t\t\tcase \"customer.subscription.deleted\":\n\t\t\t\t\tawait onSubscriptionDeleted(ctx, options, event);\n\t\t\t\t\tawait options.onEvent?.(event);\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tawait options.onEvent?.(event);\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tctx.context.logger.error(`Stripe webhook failed. Error: ${e.message}`);\n\t\t\tthrow new APIError$1(\"BAD_REQUEST\", { message: STRIPE_ERROR_CODES.STRIPE_WEBHOOK_ERROR });\n\t\t}\n\t\treturn ctx.json({ success: true });\n\t});\n};\n\n//#endregion\n//#region src/schema.ts\nconst subscriptions = { subscription: { fields: {\n\tplan: {\n\t\ttype: \"string\",\n\t\trequired: true\n\t},\n\treferenceId: {\n\t\ttype: \"string\",\n\t\trequired: true\n\t},\n\tstripeCustomerId: {\n\t\ttype: \"string\",\n\t\trequired: false\n\t},\n\tstripeSubscriptionId: {\n\t\ttype: \"string\",\n\t\trequired: false\n\t},\n\tstatus: {\n\t\ttype: \"string\",\n\t\tdefaultValue: \"incomplete\"\n\t},\n\tperiodStart: {\n\t\ttype: \"date\",\n\t\trequired: false\n\t},\n\tperiodEnd: {\n\t\ttype: \"date\",\n\t\trequired: false\n\t},\n\ttrialStart: {\n\t\ttype: \"date\",\n\t\trequired: false\n\t},\n\ttrialEnd: {\n\t\ttype: \"date\",\n\t\trequired: false\n\t},\n\tcancelAtPeriodEnd: {\n\t\ttype: \"boolean\",\n\t\trequired: false,\n\t\tdefaultValue: false\n\t},\n\tcancelAt: {\n\t\ttype: \"date\",\n\t\trequired: false\n\t},\n\tcanceledAt: {\n\t\ttype: \"date\",\n\t\trequired: false\n\t},\n\tendedAt: {\n\t\ttype: \"date\",\n\t\trequired: false\n\t},\n\tseats: {\n\t\ttype: \"number\",\n\t\trequired: false\n\t}\n} } };\nconst user = { user: { fields: { stripeCustomerId: {\n\ttype: \"string\",\n\trequired: false\n} } } };\nconst organization = { organization: { fields: { stripeCustomerId: {\n\ttype: \"string\",\n\trequired: false\n} } } };\nconst getSchema = (options) => {\n\tlet baseSchema = {};\n\tif (options.subscription?.enabled) baseSchema = {\n\t\t...subscriptions,\n\t\t...user\n\t};\n\telse baseSchema = { ...user };\n\tif (options.organization?.enabled) baseSchema = {\n\t\t...baseSchema,\n\t\t...organization\n\t};\n\tif (options.schema && !options.subscription?.enabled && \"subscription\" in options.schema) {\n\t\tconst { subscription: _subscription, ...restSchema } = options.schema;\n\t\treturn mergeSchema(baseSchema, restSchema);\n\t}\n\treturn mergeSchema(baseSchema, options.schema);\n};\n\n//#endregion\n//#region src/index.ts\nconst stripe = (options) => {\n\tconst client = options.stripeClient;\n\tconst subscriptionEndpoints = {\n\t\tupgradeSubscription: upgradeSubscription(options),\n\t\tcancelSubscriptionCallback: cancelSubscriptionCallback(options),\n\t\tcancelSubscription: cancelSubscription(options),\n\t\trestoreSubscription: restoreSubscription(options),\n\t\tlistActiveSubscriptions: listActiveSubscriptions(options),\n\t\tsubscriptionSuccess: subscriptionSuccess(options),\n\t\tcreateBillingPortal: createBillingPortal(options)\n\t};\n\treturn {\n\t\tid: \"stripe\",\n\t\tendpoints: {\n\t\t\tstripeWebhook: stripeWebhook(options),\n\t\t\t...options.subscription?.enabled ? subscriptionEndpoints : {}\n\t\t},\n\t\tinit(ctx) {\n\t\t\tif (options.organization?.enabled) {\n\t\t\t\tconst orgPlugin = ctx.getPlugin(\"organization\");\n\t\t\t\tif (!orgPlugin) {\n\t\t\t\t\tctx.logger.error(`Organization plugin not found`);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tconst existingHooks = orgPlugin.options.organizationHooks ?? {};\n\t\t\t\t/**\n\t\t\t\t* Sync organization name to Stripe customer\n\t\t\t\t*/\n\t\t\t\tconst afterUpdateStripeOrg = async (data) => {\n\t\t\t\t\tconst { organization: organization$1 } = data;\n\t\t\t\t\tif (!organization$1?.stripeCustomerId) return;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst stripeCustomer = await client.customers.retrieve(organization$1.stripeCustomerId);\n\t\t\t\t\t\tif (stripeCustomer.deleted) {\n\t\t\t\t\t\t\tctx.logger.warn(`Stripe customer ${organization$1.stripeCustomerId} was deleted`);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (organization$1.name !== stripeCustomer.name) {\n\t\t\t\t\t\t\tawait client.customers.update(organization$1.stripeCustomerId, { name: organization$1.name });\n\t\t\t\t\t\t\tctx.logger.info(`Synced organization name to Stripe: \"${stripeCustomer.name}\" â†’ \"${organization$1.name}\"`);\n\t\t\t\t\t\t}\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\tctx.logger.error(`Failed to sync organization to Stripe: ${e.message}`);\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t\t/**\n\t\t\t\t* Block deletion if organization has active subscriptions\n\t\t\t\t*/\n\t\t\t\tconst beforeDeleteStripeOrg = async (data) => {\n\t\t\t\t\tconst { organization: organization$1 } = data;\n\t\t\t\t\tif (!organization$1.stripeCustomerId) return;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst subscriptions$1 = await client.subscriptions.list({\n\t\t\t\t\t\t\tcustomer: organization$1.stripeCustomerId,\n\t\t\t\t\t\t\tstatus: \"all\",\n\t\t\t\t\t\t\tlimit: 100\n\t\t\t\t\t\t});\n\t\t\t\t\t\tfor (const sub of subscriptions$1.data) if (sub.status !== \"canceled\" && sub.status !== \"incomplete\" && sub.status !== \"incomplete_expired\") throw new APIError(\"BAD_REQUEST\", { message: STRIPE_ERROR_CODES.ORGANIZATION_HAS_ACTIVE_SUBSCRIPTION });\n\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\tif (error instanceof APIError) throw error;\n\t\t\t\t\t\tctx.logger.error(`Failed to check organization subscriptions: ${error.message}`);\n\t\t\t\t\t\tthrow error;\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t\torgPlugin.options.organizationHooks = {\n\t\t\t\t\t...existingHooks,\n\t\t\t\t\tafterUpdateOrganization: existingHooks.afterUpdateOrganization ? async (data) => {\n\t\t\t\t\t\tawait existingHooks.afterUpdateOrganization(data);\n\t\t\t\t\t\tawait afterUpdateStripeOrg(data);\n\t\t\t\t\t} : afterUpdateStripeOrg,\n\t\t\t\t\tbeforeDeleteOrganization: existingHooks.beforeDeleteOrganization ? async (data) => {\n\t\t\t\t\t\tawait existingHooks.beforeDeleteOrganization(data);\n\t\t\t\t\t\tawait beforeDeleteStripeOrg(data);\n\t\t\t\t\t} : beforeDeleteStripeOrg\n\t\t\t\t};\n\t\t\t}\n\t\t\treturn { options: { databaseHooks: { user: {\n\t\t\t\tcreate: { async after(user$1, ctx$1) {\n\t\t\t\t\tif (!ctx$1 || !options.createCustomerOnSignUp || user$1.stripeCustomerId) return;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tlet stripeCustomer = (await client.customers.search({\n\t\t\t\t\t\t\tquery: `email:\"${escapeStripeSearchValue(user$1.email)}\" AND -metadata[\"customerType\"]:\"organization\"`,\n\t\t\t\t\t\t\tlimit: 1\n\t\t\t\t\t\t})).data[0];\n\t\t\t\t\t\tif (stripeCustomer) {\n\t\t\t\t\t\t\tawait ctx$1.context.internalAdapter.updateUser(user$1.id, { stripeCustomerId: stripeCustomer.id });\n\t\t\t\t\t\t\tawait options.onCustomerCreate?.({\n\t\t\t\t\t\t\t\tstripeCustomer,\n\t\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\t\t...user$1,\n\t\t\t\t\t\t\t\t\tstripeCustomerId: stripeCustomer.id\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}, ctx$1);\n\t\t\t\t\t\t\tctx$1.context.logger.info(`Linked existing Stripe customer ${stripeCustomer.id} to user ${user$1.id}`);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tlet extraCreateParams = {};\n\t\t\t\t\t\tif (options.getCustomerCreateParams) extraCreateParams = await options.getCustomerCreateParams(user$1, ctx$1);\n\t\t\t\t\t\tconst params = defu({\n\t\t\t\t\t\t\temail: user$1.email,\n\t\t\t\t\t\t\tname: user$1.name,\n\t\t\t\t\t\t\tmetadata: {\n\t\t\t\t\t\t\t\tuserId: user$1.id,\n\t\t\t\t\t\t\t\tcustomerType: \"user\"\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}, extraCreateParams);\n\t\t\t\t\t\tstripeCustomer = await client.customers.create(params);\n\t\t\t\t\t\tawait ctx$1.context.internalAdapter.updateUser(user$1.id, { stripeCustomerId: stripeCustomer.id });\n\t\t\t\t\t\tawait options.onCustomerCreate?.({\n\t\t\t\t\t\t\tstripeCustomer,\n\t\t\t\t\t\t\tuser: {\n\t\t\t\t\t\t\t\t...user$1,\n\t\t\t\t\t\t\t\tstripeCustomerId: stripeCustomer.id\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}, ctx$1);\n\t\t\t\t\t\tctx$1.context.logger.info(`Created new Stripe customer ${stripeCustomer.id} for user ${user$1.id}`);\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\tctx$1.context.logger.error(`Failed to create or link Stripe customer: ${e.message}`, e);\n\t\t\t\t\t}\n\t\t\t\t} },\n\t\t\t\tupdate: { async after(user$1, ctx$1) {\n\t\t\t\t\tif (!ctx$1 || !user$1.stripeCustomerId) return;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst stripeCustomer = await client.customers.retrieve(user$1.stripeCustomerId);\n\t\t\t\t\t\tif (stripeCustomer.deleted) {\n\t\t\t\t\t\t\tctx$1.context.logger.warn(`Stripe customer ${user$1.stripeCustomerId} was deleted, cannot update email`);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (stripeCustomer.email !== user$1.email) {\n\t\t\t\t\t\t\tawait client.customers.update(user$1.stripeCustomerId, { email: user$1.email });\n\t\t\t\t\t\t\tctx$1.context.logger.info(`Updated Stripe customer email from ${stripeCustomer.email} to ${user$1.email}`);\n\t\t\t\t\t\t}\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\tctx$1.context.logger.error(`Failed to sync email to Stripe customer: ${e.message}`, e);\n\t\t\t\t\t}\n\t\t\t\t} }\n\t\t\t} } } };\n\t\t},\n\t\tschema: getSchema(options),\n\t\toptions,\n\t\t$ERROR_CODES: STRIPE_ERROR_CODES\n\t};\n};\n\n//#endregion\nexport { stripe };"],
  "mappings": "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",
  "names": []
}
